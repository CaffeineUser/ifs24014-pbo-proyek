<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Pesanan Saya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> 
        body { font-family: 'Poppins', sans-serif; }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
        .order-card {
            transition: all 0.3s ease;
        }
        .image-placeholder {
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .status-icon {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            border-radius: 50%;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="max-w-4xl mx-auto px-4 py-8 animate-fade-in">
        <!-- Header -->
        <div class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Pesanan Saya</h1>
                <p class="text-gray-500 mt-2">Lihat riwayat dan status pesanan makanan Anda</p>
            </div>
            <a href="/" class="flex items-center gap-2 bg-white text-orange-600 px-5 py-3 rounded-lg font-medium shadow-sm hover:bg-orange-50 hover:shadow-md transition-all duration-300 border border-orange-100">
                <i class="fas fa-arrow-left text-sm"></i>
                <span>Kembali ke Menu</span>
            </a>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="inline-flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mb-4"></div>
                <span class="text-gray-600 font-medium">Memuat pesanan...</span>
                <p class="text-gray-400 text-sm mt-2">Silakan tunggu sebentar</p>
            </div>
        </div>

        <!-- Orders Container -->
        <div id="orders-container" class="space-y-6">
            <!-- Order Cards will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
            <div class="inline-flex flex-col items-center max-w-md">
                <div class="bg-gradient-to-r from-orange-100 to-orange-50 p-6 rounded-full mb-6">
                    <i class="fas fa-shopping-bag text-orange-500 text-5xl"></i>
                </div>
                <h3 class="text-2xl font-semibold text-gray-700 mb-3">Belum ada pesanan</h3>
                <p class="text-gray-500 mb-8">Mulai pesan makanan favoritmu sekarang dan lihat riwayat pesananmu di sini</p>
                <a href="/" class="bg-gradient-to-r from-orange-600 to-orange-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-orange-500/30 hover:from-orange-700 hover:to-orange-600 transition-all transform hover:-translate-y-1">
                    <i class="fas fa-utensils mr-2"></i> Pesan Sekarang
                </a>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-16">
            <div class="inline-flex flex-col items-center max-w-md">
                <div class="bg-gradient-to-r from-red-100 to-red-50 p-6 rounded-full mb-6">
                    <i class="fas fa-exclamation-triangle text-red-500 text-5xl"></i>
                </div>
                <h3 class="text-2xl font-semibold text-gray-700 mb-3">Gagal memuat pesanan</h3>
                <p class="text-gray-500 mb-8" id="error-message"></p>
                <button onclick="location.reload()" class="bg-gradient-to-r from-orange-600 to-orange-500 text-white px-6 py-3 rounded-full font-medium shadow hover:shadow-orange-500/30 transition">
                    <i class="fas fa-redo mr-2"></i> Coba Lagi
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('orders-container');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const errorState = document.getElementById('error-state');
            const errorMessage = document.getElementById('error-message');
            
            try {
                const res = await fetch('/api/orders/my-orders', {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if(!res.ok) {
                    if(res.status === 401) {
                        // Redirect jika belum login
                        window.location.href = '/login'; 
                        return;
                    }
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const orders = await res.json();
                
                // Hide loading
                loading.classList.add('hidden');
                
                if(orders.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                // Render orders dengan gambar
                container.innerHTML = orders.map(order => `
                    <div class="order-card bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden hover:shadow-lg transition-all duration-300">
                        <!-- Order Header -->
                        <div class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b border-gray-100">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
                                <div>
                                    <p class="text-sm text-gray-500 font-medium">No. Pesanan: <span class="font-bold text-gray-700">${order.orderNumber || order.id.substring(0,8)}</span></p>
                                    <p class="text-xs text-gray-400 mt-1">
                                        <i class="far fa-clock text-xs mr-1"></i>
                                        ${new Date(order.orderDate).toLocaleString('id-ID', {
                                            day: '2-digit',
                                            month: 'long',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="status-icon ${getStatusIconColor(order.status)}">
                                        ${getStatusIcon(order.status)}
                                    </span>
                                    <span class="${getStatusColorClass(order.status)} px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide">
                                        ${getStatusText(order.status)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="p-6">
                            <h4 class="text-sm font-semibold text-gray-700 mb-4 uppercase tracking-wider">Items Pesanan</h4>
                            <div class="space-y-4">
                                ${order.items.map(item => {
                                    // Tentukan gambar berdasarkan item
                                    const imageUrl = getItemImageUrl(item.menuItem);
                                    const itemTotal = item.quantity * item.priceAtOrder;
                                    
                                    return `
                                        <div class="flex items-start gap-4 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                            <!-- Item Image -->
                                            <div class="flex-shrink-0">
                                                <div class="w-20 h-20 rounded-lg overflow-hidden shadow-sm">
                                                    <img src="${imageUrl}" 
                                                         alt="${item.menuItem.name}" 
                                                         class="w-full h-full object-cover transition-transform duration-300 hover:scale-110"
                                                         onerror="this.src='https://placehold.co/200x200/fff7ed/ea580c?text=' + encodeURIComponent('${item.menuItem.name.substring(0, 10)}')">
                                                </div>
                                            </div>
                                            
                                            <!-- Item Details -->
                                            <div class="flex-1 min-w-0">
                                                <div class="flex justify-between items-start">
                                                    <h5 class="font-medium text-gray-900 truncate" title="${item.menuItem.name}">
                                                        ${item.menuItem.name}
                                                    </h5>
                                                    <span class="text-sm font-bold text-orange-600 ml-2 whitespace-nowrap">
                                                        Rp ${item.priceAtOrder.toLocaleString('id-ID')}
                                                    </span>
                                                </div>
                                                
                                                ${item.menuItem.description ? `
                                                    <p class="text-sm text-gray-500 mt-1 line-clamp-2">
                                                        ${item.menuItem.description}
                                                    </p>
                                                ` : ''}
                                                
                                                <div class="flex items-center justify-between mt-3">
                                                    <div class="flex items-center gap-4">
                                                        <span class="text-sm text-gray-600">
                                                            <span class="font-bold">${item.quantity}</span> pcs
                                                        </span>
                                                        ${item.notes ? `
                                                            <span class="text-xs text-gray-500" title="Catatan: ${item.notes}">
                                                                <i class="fas fa-sticky-note mr-1"></i> Ada catatan
                                                            </span>
                                                        ` : ''}
                                                    </div>
                                                    <span class="font-bold text-gray-800">
                                                        Rp ${itemTotal.toLocaleString('id-ID')}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Order Footer -->
                        <div class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-t border-gray-100">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                                <div class="text-sm text-gray-600">
                                    ${order.paymentMethod ? `
                                        <p><span class="font-medium">Metode Pembayaran:</span> ${order.paymentMethod}</p>
                                    ` : ''}
                                    ${order.deliveryAddress ? `
                                        <p class="mt-1"><span class="font-medium">Alamat Pengiriman:</span> ${order.deliveryAddress.substring(0, 50)}${order.deliveryAddress.length > 50 ? '...' : ''}</p>
                                    ` : ''}
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500 mb-1">Total Pembayaran</p>
                                    <p class="text-2xl font-bold text-orange-600">
                                        Rp ${order.totalAmount.toLocaleString('id-ID')}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch(e) {
                console.error('Error loading orders:', e);
                loading.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessage.textContent = e.message || 'Terjadi kesalahan saat memuat data pesanan. Silakan coba lagi.';
            }
        });

        // Helper functions
        function getStatusColorClass(status) {
            switch(status.toUpperCase()) {
                case 'PENDING': return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                case 'CONFIRMED': 
                case 'PROCESSING': return 'bg-blue-100 text-blue-800 border border-blue-200';
                case 'ON_DELIVERY': 
                case 'DELIVERING': return 'bg-purple-100 text-purple-800 border border-purple-200';
                case 'COMPLETED': 
                case 'DELIVERED': return 'bg-green-100 text-green-800 border border-green-200';
                case 'CANCELLED': 
                case 'FAILED': return 'bg-red-100 text-red-800 border border-red-200';
                default: return 'bg-gray-100 text-gray-800 border border-gray-200';
            }
        }

        function getStatusIcon(status) {
            switch(status.toUpperCase()) {
                case 'PENDING': return '‚è≥';
                case 'CONFIRMED': 
                case 'PROCESSING': return 'üë®‚Äçüç≥';
                case 'ON_DELIVERY': 
                case 'DELIVERING': return 'üöö';
                case 'COMPLETED': 
                case 'DELIVERED': return '‚úÖ';
                case 'CANCELLED': 
                case 'FAILED': return '‚ùå';
                default: return 'üì¶';
            }
        }

        function getStatusIconColor(status) {
            switch(status.toUpperCase()) {
                case 'PENDING': return 'bg-yellow-500 text-white';
                case 'CONFIRMED': 
                case 'PROCESSING': return 'bg-blue-500 text-white';
                case 'ON_DELIVERY': 
                case 'DELIVERING': return 'bg-purple-500 text-white';
                case 'COMPLETED': 
                case 'DELIVERED': return 'bg-green-500 text-white';
                case 'CANCELLED': 
                case 'FAILED': return 'bg-red-500 text-white';
                default: return 'bg-gray-500 text-white';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'Menunggu Konfirmasi',
                'CONFIRMED': 'Dikonfirmasi',
                'PROCESSING': 'Sedang Diproses',
                'ON_DELIVERY': 'Dalam Pengiriman',
                'DELIVERING': 'Dalam Pengiriman',
                'COMPLETED': 'Selesai',
                'DELIVERED': 'Terkirim',
                'CANCELLED': 'Dibatalkan',
                'FAILED': 'Gagal'
            };
            return statusMap[status.toUpperCase()] || status;
        }

        function getItemImageUrl(menuItem) {
            // Jika item memiliki imageUrl, gunakan itu
            if (menuItem.imageUrl) {
                return menuItem.imageUrl.startsWith('http') ? menuItem.imageUrl : `/uploads/${menuItem.imageUrl}`;
            }
            
            // Fallback: Tentukan gambar berdasarkan nama item
            const itemName = menuItem.name.toLowerCase();
            
            if (itemName.includes('nasi goreng') || itemName.includes('fried rice')) {
                return 'https://images.unsplash.com/photo-1633945274309-2c16c9682a8c?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80';
            }
            else if (itemName.includes('es teh') || itemName.includes('ice tea') || itemName.includes('teh manis')) {
                return 'https://images.unsplash.com/photo-1629203851122-3726ecdf080e?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80';
            }
            else if (itemName.includes('ayam') || itemName.includes('chicken')) {
                return 'https://images.unsplash.com/photo-1626645738196-c2a7c87a8f58?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80';
            }
            else if (itemName.includes('burger') || itemName.includes('burger')) {
                return 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80';
            }
            else if (itemName.includes('pizza')) {
                return 'https://images.unsplash.com/photo-1604068549290-dea0e4a305ca?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80';
            }
            else if (itemName.includes('kopi') || itemName.includes('coffee')) {
                return 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80';
            }
            else if (itemName.includes('jus') || itemName.includes('juice')) {
                return 'https://images.unsplash.com/photo-1621506289937-a8e4df240d0b?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80';
            }
            else {
                // Placeholder dengan warna yang sesuai brand
                return `https://placehold.co/200x200/fff7ed/ea580c?text=${encodeURIComponent(menuItem.name.substring(0, 15))}`;
            }
        }
    </script>
</body>
</html>